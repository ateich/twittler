<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script type="date.js"></script>
    <script src="data_generator.js"></script>
    <script src="moment.js"></script>
    <script src="jquery.magnific-popup.js"></script> 

    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="magnific-popup/magnific-popup.css"> 
  </head>
  <body>
    <script>

      $(document).ready(function(){
        var $body = $('body');
        $body.html('');

        var index = streams.home.length - 1;
        var lastTweetTime = 0;

        var tweetCount = 0;

        findAndAddNewTweets();

        function addTweetTo(tweet, appendTo)
        {
          var $tweet = $('<div class="tweet"></div>');

          var postTime = moment(tweet.created_at).fromNow();

          $tweet.append('<a href="#test-popup" class="open-popup-link username" data-user="' + tweet.user + '"><p>' + tweet.user + '</p></a>');
          $tweet.append('<p>' + tweet.message + '</p>');
          $tweet.append('<p class="postTime" data-postTime="' + tweet.created_at + '">' + postTime + '</p>');
          $tweet.append('<hr/>');

          $tweet.appendTo(appendTo);
        }

        //Check for newer tweets every 1 minute
        var checkForNewTweets = setInterval(function(){
          findAndAddNewTweets();
        }, 60000);

        function findAndAddNewTweets()
        {
          var $newTweets = $('<div></div>');
          var index = streams.home.length - 1;

          var tweet = streams.home[index];
          //var latestTweetTime = Date.parse(tweet.created_at);

          //There are new tweets to be added to the screen
          while(streams.home.length > tweetCount)
          {
            addTweetTo(tweet, $newTweets);

            tweet = streams.home[index];
            index-=1;

            //lastTweetTime = latestTweetTime;
            //lastTweetTime = Date.parse(tweet.created_at);
            tweetCount += 1;
          }

          //lastTweetTime = Date.parse(streams.home[0].created_at);
          $newTweets.prependTo($body);

          //Enable clicking on username to open user twitter stream
          $('.open-popup-link').magnificPopup({
            closeBtnInside: true,
            callbacks : {
              elementParse : function(item){
                var usernameClicked = this.st.el.data('user');
                item.src = '<div class="white-popup">' + usernameClicked + '</div>';
              }
            },
            items: {
                src: '',
                type: 'inline'
            }
          });
        }

        //Every minute, loop through tweets on screen to update their user friendly post time
        var updateTweetTime = setInterval(function()
        {
          $('.postTime').each(function(i, obj)
          {
            $(obj).text(moment($(obj).data("posttime")).fromNow());
          });
        }, 60000);

      });

    </script>
  </body>
</html>
