<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script type="date.js"></script>
    <script src="data_generator.js"></script>
    <script src="moment.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <script>

      $(document).ready(function(){
        var $body = $('body');
        $body.html('');

        var index = streams.home.length - 1;
        var lastTweetTime;

        //Loop through and add tweets
        while(index >= 0){
          var tweet = streams.home[index];
          addTweetTo(tweet, $body);
          index -= 1;

          //Keep track of the most recent tweets posting time
          var tweetTime = Date.parse(tweet.created_at);
          if(!lastTweetTime || tweetTime > lastTweetTime)
          {
            lastTweetTime = tweetTime;
          }
        }

        function addTweetTo(tweet, appendTo)
        {
          var $tweet = $('<div class="tweet"></div>');

          var postTime = moment(tweet.created_at).fromNow();

          $tweet.append('<p class="username">' + tweet.user + '</p>');
          $tweet.append('<p>' + tweet.message + '</p>');
          $tweet.append('<p class="postTime" data-postTime="' + tweet.created_at + '">' + postTime + '</p>');
          $tweet.append('<hr/>');

          $tweet.appendTo(appendTo);
        }

        //Check for newer tweets every 1 minute
        var checkForNewTweets = setInterval(function(){

          var $newTweets = $('<div></div>');
          var index = streams.home.length - 1;

          var tweet = streams.home[index];
          var latestTweetTime = Date.parse(tweet.created_at);

          if(latestTweetTime > lastTweetTime)
          {
            var tweetsAdded = 0;
            //There are new tweets to be added to the screen
            while(latestTweetTime > lastTweetTime)
            {
              tweetsAdded+=1;
              addTweetTo(tweet, $newTweets);

              index-=1;
              tweet = streams.home[index];

              //lastTweetTime = latestTweetTime;
              latestTweetTime = Date.parse(tweet.created_at);
            }

            latestTweetTime = Date.parse(streams.home[0].created_at);
            $newTweets.prependTo($body);
          }
        }, 60000);

        //Every minute, loop through tweets on screen to update their user friendly post time
        var updateTweetTime = setInterval(function()
        {
          $('.postTime').each(function(i, obj)
          {
            //console.log(moment($(obj).data("posttime")).fromNow());
            $(obj).text(moment($(obj).data("posttime")).fromNow());
          });
        }, 60000);

      });

    </script>
  </body>
</html>
